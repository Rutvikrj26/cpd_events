============================= test session starts ==============================
platform darwin -- Python 3.13.4, pytest-8.4.2, pluggy-1.6.0
django: version: 6.0, settings: config.settings.development (from env)
rootdir: /Users/rutvikrj26/Desktop/cpd_events/backend
configfile: pyproject.toml
plugins: cov-4.1.0, django-4.11.1, Faker-22.7.0
collected 4 items

src/organizations/tests/test_plans_and_billing.py FFFF                   [100%]

=================================== FAILURES ===================================
________________ TestOrganizationPlansAndBilling.test_get_plans ________________

self = <organizations.tests.test_plans_and_billing.TestOrganizationPlansAndBilling object at 0x10bc54e10>
organizer_client = <rest_framework.test.APIClient object at 0x10bd642f0>

    def test_get_plans(self, organizer_client):
>       response = organizer_client.get('/api/v1/organizations/plans/')
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

src/organizations/tests/test_plans_and_billing.py:32: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/rest_framework/test.py:292: in get
    response = super().get(path, data=data, **extra)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/test.py:209: in get
    return self.generic('GET', path, **r)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/test.py:237: in generic
    return super().generic(
.venv/lib/python3.13/site-packages/django/test/client.py:671: in generic
    return self.request(**r)
           ^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/test.py:289: in request
    return super().request(**kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/test.py:241: in request
    request = super().request(**kwargs)
              ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/django/test/client.py:1087: in request
    self.check_exception(response)
.venv/lib/python3.13/site-packages/django/test/client.py:802: in check_exception
    raise exc_value
.venv/lib/python3.13/site-packages/django/core/handlers/exception.py:55: in inner
    response = get_response(request)
               ^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/django/core/handlers/base.py:198: in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/django/views/decorators/csrf.py:65: in _view_wrapper
    return view_func(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/viewsets.py:125: in view
    return self.dispatch(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/views.py:515: in dispatch
    response = self.handle_exception(exc)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/views.py:475: in handle_exception
    self.raise_uncaught_exception(exc)
.venv/lib/python3.13/site-packages/rest_framework/views.py:486: in raise_uncaught_exception
    raise exc
.venv/lib/python3.13/site-packages/rest_framework/views.py:512: in dispatch
    response = handler(request, *args, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <organizations.views.OrganizationViewSet object at 0x10d5dba10>
request = <rest_framework.request.Request: GET '/api/v1/organizations/plans/'>

    @action(detail=False, methods=['get'], permission_classes=[AllowAny])
    def plans(self, request):
        """
        Get available organization plans and capabilities.
        """
>       from billing.models import OrganizationSubscription
E       ImportError: cannot import name 'OrganizationSubscription' from 'billing.models' (/Users/rutvikrj26/Desktop/cpd_events/backend/src/billing/models.py)

src/organizations/views.py:486: ImportError
---------------------------- Captured stdout setup -----------------------------
Migrated 0 starter subscriptions to professional
Migrated 0 premium subscriptions to organization
Migrated 0 subscriptions from 'organizer' to 'professional'
----------------------------- Captured stderr call -----------------------------
Internal Server Error: /api/v1/organizations/plans/
Traceback (most recent call last):
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/core/handlers/exception.py", line 55, in inner
    response = get_response(request)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/core/handlers/base.py", line 198, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/views/decorators/csrf.py", line 65, in _view_wrapper
    return view_func(request, *args, **kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/viewsets.py", line 125, in view
    return self.dispatch(request, *args, **kwargs)
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 515, in dispatch
    response = self.handle_exception(exc)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 475, in handle_exception
    self.raise_uncaught_exception(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 486, in raise_uncaught_exception
    raise exc
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 512, in dispatch
    response = handler(request, *args, **kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/src/organizations/views.py", line 486, in plans
    from billing.models import OrganizationSubscription
ImportError: cannot import name 'OrganizationSubscription' from 'billing.models' (/Users/rutvikrj26/Desktop/cpd_events/backend/src/billing/models.py)
------------------------------ Captured log call -------------------------------
ERROR    django.request:log.py:249 Internal Server Error: /api/v1/organizations/plans/
Traceback (most recent call last):
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/core/handlers/exception.py", line 55, in inner
    response = get_response(request)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/core/handlers/base.py", line 198, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/views/decorators/csrf.py", line 65, in _view_wrapper
    return view_func(request, *args, **kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/viewsets.py", line 125, in view
    return self.dispatch(request, *args, **kwargs)
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 515, in dispatch
    response = self.handle_exception(exc)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 475, in handle_exception
    self.raise_uncaught_exception(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 486, in raise_uncaught_exception
    raise exc
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 512, in dispatch
    response = handler(request, *args, **kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/src/organizations/views.py", line 486, in plans
    from billing.models import OrganizationSubscription
ImportError: cannot import name 'OrganizationSubscription' from 'billing.models' (/Users/rutvikrj26/Desktop/cpd_events/backend/src/billing/models.py)
__________ TestOrganizationPlansAndBilling.test_upgrade_subscription ___________

self = <organizations.tests.test_plans_and_billing.TestOrganizationPlansAndBilling object at 0x10bc551d0>
mock_stripe = <MagicMock name='stripe_service' id='4519683344'>
organizer_client = <rest_framework.test.APIClient object at 0x10ce24f50>
organization = <Organization: Test Org>

    @patch('organizations.views.stripe_service')
    def test_upgrade_subscription(self, mock_stripe, organizer_client, organization):
        mock_stripe.create_checkout_session.return_value = {'success': True, 'url': 'https://stripe.com/checkout'}
    
        url = f'/api/v1/organizations/{organization.slug}/subscription/upgrade/'
        data = {'plan': 'team'}
    
        response = organizer_client.post(url, data)
>       assert response.status_code == 200
E       assert 403 == 200
E        +  where 403 = <Response status_code=403, "application/json">.status_code

src/organizations/tests/test_plans_and_billing.py:46: AssertionError
----------------------------- Captured stderr call -----------------------------
Forbidden: /api/v1/organizations/test-org/subscription/upgrade/
------------------------------ Captured log call -------------------------------
WARNING  django.request:log.py:249 Forbidden: /api/v1/organizations/test-org/subscription/upgrade/
________ TestOrganizationPlansAndBilling.test_invite_organizer_external ________

self = <organizations.tests.test_plans_and_billing.TestOrganizationPlansAndBilling object at 0x10bc3c770>
mock_email = <MagicMock name='email_service' id='4519685360'>
organizer_client = <rest_framework.test.APIClient object at 0x10d759a90>
organization = <Organization: Test Org>

    @patch('organizations.views.email_service')
    def test_invite_organizer_external(self, mock_email, organizer_client, organization):
        # Ensure invitee exists
        invitee = User.objects.create_user(email='invitee@example.com', password='pw', full_name='Invitee')
    
        url = f'/api/v1/organizations/{organization.slug}/link-organizer/'
        data = {'organizer_email': 'invitee@example.com', 'role': 'member'}
    
        response = organizer_client.post(url, data)
>       assert response.status_code == 201
E       assert 403 == 201
E        +  where 403 = <Response status_code=403, "application/json">.status_code

src/organizations/tests/test_plans_and_billing.py:59: AssertionError
----------------------------- Captured stderr call -----------------------------
Forbidden: /api/v1/organizations/test-org/link-organizer/
------------------------------ Captured log call -------------------------------
WARNING  django.request:log.py:249 Forbidden: /api/v1/organizations/test-org/link-organizer/
______ TestOrganizationPlansAndBilling.test_invite_organizer_non_existent ______

self = <organizations.tests.test_plans_and_billing.TestOrganizationPlansAndBilling object at 0x10bc3c9d0>
mock_email = <MagicMock name='email_service' id='4519683344'>
organizer_client = <rest_framework.test.APIClient object at 0x10ce2b360>
organization = <Organization: Test Org>

    @patch('organizations.views.email_service')
    def test_invite_organizer_non_existent(self, mock_email, organizer_client, organization):
        url = f'/api/v1/organizations/{organization.slug}/link-organizer/'
        data = {'organizer_email': 'nobody@example.com', 'role': 'member'}
    
        response = organizer_client.post(url, data)
>       assert response.status_code == 400
E       assert 403 == 400
E        +  where 403 = <Response status_code=403, "application/json">.status_code

src/organizations/tests/test_plans_and_billing.py:71: AssertionError
----------------------------- Captured stderr call -----------------------------
Forbidden: /api/v1/organizations/test-org/link-organizer/
------------------------------ Captured log call -------------------------------
WARNING  django.request:log.py:249 Forbidden: /api/v1/organizations/test-org/link-organizer/
=============================== warnings summary ===============================
src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_get_plans
src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_upgrade_subscription
src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_invite_organizer_external
src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_invite_organizer_non_existent
  /Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/core/handlers/base.py:62: UserWarning: No directory at: /Users/rutvikrj26/Desktop/cpd_events/backend/src/staticfiles/
    mw_instance = middleware(adapted_handler)

src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_get_plans
  /Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/drf_yasg/views.py:100: DeprecationWarning: SwaggerJSONRenderer & SwaggerYAMLRenderer's `format` has changed to not include a `.` prefix, please silence this warning by setting `SWAGGER_USE_COMPAT_RENDERERS = False` in your Django settings and ensure your application works (check your URLCONF and swagger/redoc URLs).
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_get_plans
FAILED src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_upgrade_subscription
FAILED src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_invite_organizer_external
FAILED src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_invite_organizer_non_existent
======================== 4 failed, 5 warnings in 8.95s =========================
