============================= test session starts ==============================
platform darwin -- Python 3.13.4, pytest-8.4.2, pluggy-1.6.0
django: version: 6.0, settings: config.settings.development (from env)
rootdir: /Users/rutvikrj26/Desktop/cpd_events/backend
configfile: pyproject.toml
plugins: cov-4.1.0, django-4.11.1, Faker-22.7.0
collected 4 items

src/organizations/tests/test_plans_and_billing.py Migrated 0 starter subscriptions to professional
Migrated 0 premium subscriptions to organization
Migrated 0 subscriptions from 'organizer' to 'professional'
.Forbidden: /api/v1/organizations/74549bdd-da0e-485c-ba82-8a701bdc44a8/subscription/upgrade/

User Email: organizer@example.com
User Sub Plan: professional
Org UUID: 74549bdd-da0e-485c-ba82-8a701bdc44a8
Membership exists: True
Response: 403 - {'error': {'code': 'PERMISSION_DENIED', 'message': ErrorDetail(string='Your subscription plan does not allow access to this resource.', code='permission_denied'), 'details': None}}
FForbidden: /api/v1/organizations/2ec633c7-ba0f-4dfb-8f79-0dacf9607bb5/link-organizer/
FForbidden: /api/v1/organizations/68167d57-54c2-4106-aab8-b63004e26fe2/link-organizer/
F

=================================== FAILURES ===================================
__________ TestOrganizationPlansAndBilling.test_upgrade_subscription ___________

self = <organizations.tests.test_plans_and_billing.TestOrganizationPlansAndBilling object at 0x1105b0b90>
mock_stripe = <MagicMock name='stripe_service' id='4596549680'>
organizer_client = <rest_framework.test.APIClient object at 0x111f3d450>
organization = <Organization: Test Org>

    @patch('organizations.views.stripe_service')
    def test_upgrade_subscription(self, mock_stripe, organizer_client, organization):
        mock_stripe.create_checkout_session.return_value = {'success': True, 'url': 'https://stripe.com/checkout'}
    
        url = f'/api/v1/organizations/{organization.uuid}/subscription/upgrade/'
        data = {'plan': 'team'}
    
    
        # Debugging 403
        from organizations.models import OrganizationMembership
        print(f"\nUser Email: {organizer_client.handler._force_user.email}")
        print(f"User Sub Plan: {getattr(organizer_client.handler._force_user.subscription, 'plan', 'None')}")
        print(f"Org UUID: {organization.uuid}")
        print(f"Membership exists: {OrganizationMembership.objects.filter(organization=organization, user=organizer_client.handler._force_user).exists()}")
    
        response = organizer_client.post(url, data)
        print(f"Response: {response.status_code} - {response.data}")
>       assert response.status_code == 200
E       assert 403 == 200
E        +  where 403 = <Response status_code=403, "application/json">.status_code

src/organizations/tests/test_plans_and_billing.py:70: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  django.request:log.py:249 Forbidden: /api/v1/organizations/74549bdd-da0e-485c-ba82-8a701bdc44a8/subscription/upgrade/
________ TestOrganizationPlansAndBilling.test_invite_organizer_external ________

self = <organizations.tests.test_plans_and_billing.TestOrganizationPlansAndBilling object at 0x110590510>
mock_email = <MagicMock name='email_service' id='4595185184'>
organizer_client = <rest_framework.test.APIClient object at 0x111fcc690>
organization = <Organization: Test Org>

    @patch('organizations.views.email_service')
    def test_invite_organizer_external(self, mock_email, organizer_client, organization):
        # Ensure invitee exists
        invitee = User.objects.create_user(email='invitee@example.com', password='pw', full_name='Invitee')
    
        url = f'/api/v1/organizations/{organization.uuid}/link-organizer/'
        data = {'organizer_email': 'invitee@example.com', 'role': 'member'}
    
        response = organizer_client.post(url, data)
>       assert response.status_code == 201
E       assert 403 == 201
E        +  where 403 = <Response status_code=403, "application/json">.status_code

src/organizations/tests/test_plans_and_billing.py:83: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  django.request:log.py:249 Forbidden: /api/v1/organizations/2ec633c7-ba0f-4dfb-8f79-0dacf9607bb5/link-organizer/
______ TestOrganizationPlansAndBilling.test_invite_organizer_non_existent ______

self = <organizations.tests.test_plans_and_billing.TestOrganizationPlansAndBilling object at 0x110590770>
mock_email = <MagicMock name='email_service' id='4595185520'>
organizer_client = <rest_framework.test.APIClient object at 0x111ef6520>
organization = <Organization: Test Org>

    @patch('organizations.views.email_service')
    def test_invite_organizer_non_existent(self, mock_email, organizer_client, organization):
        url = f'/api/v1/organizations/{organization.uuid}/link-organizer/'
        data = {'organizer_email': 'nobody@example.com', 'role': 'member'}
    
        response = organizer_client.post(url, data)
>       assert response.status_code == 400
E       assert 403 == 400
E        +  where 403 = <Response status_code=403, "application/json">.status_code

src/organizations/tests/test_plans_and_billing.py:95: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  django.request:log.py:249 Forbidden: /api/v1/organizations/68167d57-54c2-4106-aab8-b63004e26fe2/link-organizer/
=============================== warnings summary ===============================
src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_get_plans
src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_upgrade_subscription
src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_invite_organizer_external
src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_invite_organizer_non_existent
  /Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/core/handlers/base.py:62: UserWarning: No directory at: /Users/rutvikrj26/Desktop/cpd_events/backend/src/staticfiles/
    mw_instance = middleware(adapted_handler)

src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_get_plans
  /Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/drf_yasg/views.py:100: DeprecationWarning: SwaggerJSONRenderer & SwaggerYAMLRenderer's `format` has changed to not include a `.` prefix, please silence this warning by setting `SWAGGER_USE_COMPAT_RENDERERS = False` in your Django settings and ensure your application works (check your URLCONF and swagger/redoc URLs).
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_upgrade_subscription
FAILED src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_invite_organizer_external
FAILED src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_invite_organizer_non_existent
=================== 3 failed, 1 passed, 5 warnings in 10.61s ===================
