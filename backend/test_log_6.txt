============================= test session starts ==============================
platform darwin -- Python 3.13.4, pytest-8.4.2, pluggy-1.6.0
django: version: 6.0, settings: config.settings.development (from env)
rootdir: /Users/rutvikrj26/Desktop/cpd_events/backend
configfile: pyproject.toml
plugins: cov-4.1.0, django-4.11.1, Faker-22.7.0
collected 4 items

src/organizations/tests/test_plans_and_billing.py .FF.                   [100%]

=================================== FAILURES ===================================
__________ TestOrganizationPlansAndBilling.test_upgrade_subscription ___________

self = <organizations.tests.test_plans_and_billing.TestOrganizationPlansAndBilling object at 0x10fe7d1d0>
mock_stripe = <MagicMock name='stripe_service' id='4589851312'>
organizer_client = <rest_framework.test.APIClient object at 0x111816c10>
organization = <Organization: Test Org>

    @patch('organizations.views.stripe_service')
    def test_upgrade_subscription(self, mock_stripe, organizer_client, organization):
        mock_stripe.create_checkout_session.return_value = {'success': True, 'url': 'https://stripe.com/checkout'}
    
        url = f'/api/v1/organizations/{organization.uuid}/subscription/upgrade/'
        data = {'plan': 'team'}
    
    
>       response = organizer_client.post(url, data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

src/organizations/tests/test_plans_and_billing.py:66: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/rest_framework/test.py:299: in post
    response = super().post(
.venv/lib/python3.13/site-packages/rest_framework/test.py:213: in post
    return self.generic('POST', path, data, content_type, **extra)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/test.py:237: in generic
    return super().generic(
.venv/lib/python3.13/site-packages/django/test/client.py:671: in generic
    return self.request(**r)
           ^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/test.py:289: in request
    return super().request(**kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/test.py:241: in request
    request = super().request(**kwargs)
              ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/django/test/client.py:1087: in request
    self.check_exception(response)
.venv/lib/python3.13/site-packages/django/test/client.py:802: in check_exception
    raise exc_value
.venv/lib/python3.13/site-packages/django/core/handlers/exception.py:55: in inner
    response = get_response(request)
               ^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/django/core/handlers/base.py:198: in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/django/views/decorators/csrf.py:65: in _view_wrapper
    return view_func(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/viewsets.py:125: in view
    return self.dispatch(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/views.py:515: in dispatch
    response = self.handle_exception(exc)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/views.py:475: in handle_exception
    self.raise_uncaught_exception(exc)
.venv/lib/python3.13/site-packages/rest_framework/views.py:486: in raise_uncaught_exception
    raise exc
.venv/lib/python3.13/site-packages/rest_framework/views.py:512: in dispatch
    response = handler(request, *args, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/organizations/views.py:465: in upgrade_subscription
    success_url = f"{settings.FRONTEND_URL}/dashboard/organizations/{organization.slug}/billing?success=true"
                     ^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <LazySettings "config.settings.development">, name = 'FRONTEND_URL'

    def __getattr__(self, name):
        """Return the value of a setting and cache it in self.__dict__."""
        if (_wrapped := self._wrapped) is empty:
            self._setup(name)
            _wrapped = self._wrapped
>       val = getattr(_wrapped, name)
              ^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'Settings' object has no attribute 'FRONTEND_URL'

.venv/lib/python3.13/site-packages/django/conf/__init__.py:77: AttributeError
----------------------------- Captured stderr call -----------------------------
Internal Server Error: /api/v1/organizations/01e4578a-37b5-4e98-a094-bd2af5534496/subscription/upgrade/
Traceback (most recent call last):
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/core/handlers/exception.py", line 55, in inner
    response = get_response(request)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/core/handlers/base.py", line 198, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/views/decorators/csrf.py", line 65, in _view_wrapper
    return view_func(request, *args, **kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/viewsets.py", line 125, in view
    return self.dispatch(request, *args, **kwargs)
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 515, in dispatch
    response = self.handle_exception(exc)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 475, in handle_exception
    self.raise_uncaught_exception(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 486, in raise_uncaught_exception
    raise exc
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 512, in dispatch
    response = handler(request, *args, **kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/src/organizations/views.py", line 465, in upgrade_subscription
    success_url = f"{settings.FRONTEND_URL}/dashboard/organizations/{organization.slug}/billing?success=true"
                     ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/conf/__init__.py", line 77, in __getattr__
    val = getattr(_wrapped, name)
AttributeError: 'Settings' object has no attribute 'FRONTEND_URL'
------------------------------ Captured log call -------------------------------
ERROR    django.request:log.py:249 Internal Server Error: /api/v1/organizations/01e4578a-37b5-4e98-a094-bd2af5534496/subscription/upgrade/
Traceback (most recent call last):
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/core/handlers/exception.py", line 55, in inner
    response = get_response(request)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/core/handlers/base.py", line 198, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/views/decorators/csrf.py", line 65, in _view_wrapper
    return view_func(request, *args, **kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/viewsets.py", line 125, in view
    return self.dispatch(request, *args, **kwargs)
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 515, in dispatch
    response = self.handle_exception(exc)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 475, in handle_exception
    self.raise_uncaught_exception(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 486, in raise_uncaught_exception
    raise exc
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 512, in dispatch
    response = handler(request, *args, **kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/src/organizations/views.py", line 465, in upgrade_subscription
    success_url = f"{settings.FRONTEND_URL}/dashboard/organizations/{organization.slug}/billing?success=true"
                     ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/conf/__init__.py", line 77, in __getattr__
    val = getattr(_wrapped, name)
AttributeError: 'Settings' object has no attribute 'FRONTEND_URL'
________ TestOrganizationPlansAndBilling.test_invite_organizer_external ________

self = <organizations.tests.test_plans_and_billing.TestOrganizationPlansAndBilling object at 0x10fe64640>
mock_email = <MagicMock name='email_service' id='4589855344'>
organizer_client = <rest_framework.test.APIClient object at 0x111966490>
organization = <Organization: Test Org>

    @patch('organizations.views.email_service')
    def test_invite_organizer_external(self, mock_email, organizer_client, organization):
        # Ensure invitee exists
        invitee = User.objects.create_user(email='invitee@example.com', password='pw', full_name='Invitee')
    
        url = f'/api/v1/organizations/{organization.uuid}/link-organizer/'
        data = {'organizer_email': 'invitee@example.com', 'role': 'member'}
    
>       response = organizer_client.post(url, data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

src/organizations/tests/test_plans_and_billing.py:79: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/rest_framework/test.py:299: in post
    response = super().post(
.venv/lib/python3.13/site-packages/rest_framework/test.py:213: in post
    return self.generic('POST', path, data, content_type, **extra)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/test.py:237: in generic
    return super().generic(
.venv/lib/python3.13/site-packages/django/test/client.py:671: in generic
    return self.request(**r)
           ^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/test.py:289: in request
    return super().request(**kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/test.py:241: in request
    request = super().request(**kwargs)
              ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/django/test/client.py:1087: in request
    self.check_exception(response)
.venv/lib/python3.13/site-packages/django/test/client.py:802: in check_exception
    raise exc_value
.venv/lib/python3.13/site-packages/django/core/handlers/exception.py:55: in inner
    response = get_response(request)
               ^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/django/core/handlers/base.py:198: in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/django/views/decorators/csrf.py:65: in _view_wrapper
    return view_func(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/viewsets.py:125: in view
    return self.dispatch(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/views.py:515: in dispatch
    response = self.handle_exception(exc)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/views.py:475: in handle_exception
    self.raise_uncaught_exception(exc)
.venv/lib/python3.13/site-packages/rest_framework/views.py:486: in raise_uncaught_exception
    raise exc
.venv/lib/python3.13/site-packages/rest_framework/views.py:512: in dispatch
    response = handler(request, *args, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <organizations.views.OrganizationViewSet object at 0x111a84550>
request = <rest_framework.request.Request: POST '/api/v1/organizations/d063d1a8-8c2d-41c2-a4a2-e54afabc3ade/link-organizer/'>
pk = 'd063d1a8-8c2d-41c2-a4a2-e54afabc3ade'

    @action(detail=True, methods=['post'], url_path='link-organizer')
    def link_organizer(self, request, pk=None):
        """Link an individual organizer's data to this organization."""
        organization = self.get_object()
    
        # Check admin permission
        if not organization.memberships.filter(
            user=request.user, role__in=['owner', 'admin'], is_active=True
        ).exists():
            return Response(
                {'detail': 'You do not have permission to link organizers.'},
                status=status.HTTP_403_FORBIDDEN,
            )
    
        serializer = LinkOrganizerSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
    
        # Link current user's data if no email specified
        if not serializer.validated_data.get('organizer_email'):
            result = OrganizationLinkingService.link_organizer_to_org(
                user=request.user,
                organization=organization,
                role=serializer.validated_data['role'],
            )
            return Response({
                'detail': 'Your data has been linked to this organization.',
                'events_transferred': result['events_transferred'],
                'templates_transferred': result['templates_transferred'],
            })
    
        # Handle invitation for external email
        if serializer.validated_data.get('organizer_email'):
            email = serializer.validated_data['organizer_email']
            role = serializer.validated_data['role']
    
            # Check if membership already exists
            if OrganizationMembership.objects.filter(organization=organization, user__email=email, is_active=True).exists():
                 return Response(
                    {'detail': 'User is already a member of this organization.'},
                    status=status.HTTP_400_BAD_REQUEST,
                )
    
            # Create pending membership (if user exists) or just send invite logic
            # For simplicity, we'll assume the user might not exist yet, but we need a user object for membership
            # if we strictly follow the model. However, commonly invites track email.
            # The model OrganizationMembership REQUIRES a user ForeignKey.
            # So typically we need to invite them to join the PLATFORM first, or if they exist, link them.
    
            # Re-checking model: OrganizationMembership has `user = ForeignKey`.
            # So we can only invite EXISTING users for now, unless we change the model to allow null user (which we haven't planned).
            # But wait, looking at the code I viewed earlier...
            # OrganizationMembership fields:
            # user = models.ForeignKey(settings.AUTH_USER_MODEL, ...) (Not null usually, let's check model again... yes on_delete=CASCADE)
            # So we can only invite existing users.
    
            from django.contrib.auth import get_user_model
            User = get_user_model()
    
            try:
                user_to_invite = User.objects.get(email=email)
            except User.DoesNotExist:
                 return Response(
                    {'detail': 'User with this email does not exist. Please ask them to sign up first.'},
                    status=status.HTTP_400_BAD_REQUEST,
                )
    
            # Create pending membership
            membership, created = OrganizationMembership.objects.get_or_create(
                organization=organization,
                user=user_to_invite,
                defaults={
                    'role': role,
                    'is_active': False, # Pending acceptance
                    'invited_by': request.user,
                }
            )
    
            # Generate token
            token = membership.generate_invitation_token()
    
            # Send email
>           invite_url = f"{settings.FRONTEND_URL}/dashboard/organizations/accept-invite?token={token}"
                            ^^^^^^^^
E           NameError: name 'settings' is not defined

src/organizations/views.py:373: NameError
----------------------------- Captured stderr call -----------------------------
Internal Server Error: /api/v1/organizations/d063d1a8-8c2d-41c2-a4a2-e54afabc3ade/link-organizer/
Traceback (most recent call last):
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/core/handlers/exception.py", line 55, in inner
    response = get_response(request)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/core/handlers/base.py", line 198, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/views/decorators/csrf.py", line 65, in _view_wrapper
    return view_func(request, *args, **kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/viewsets.py", line 125, in view
    return self.dispatch(request, *args, **kwargs)
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 515, in dispatch
    response = self.handle_exception(exc)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 475, in handle_exception
    self.raise_uncaught_exception(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 486, in raise_uncaught_exception
    raise exc
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 512, in dispatch
    response = handler(request, *args, **kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/src/organizations/views.py", line 373, in link_organizer
    invite_url = f"{settings.FRONTEND_URL}/dashboard/organizations/accept-invite?token={token}"
                    ^^^^^^^^
NameError: name 'settings' is not defined. Did you mean: 'self.settings'?
------------------------------ Captured log call -------------------------------
ERROR    django.request:log.py:249 Internal Server Error: /api/v1/organizations/d063d1a8-8c2d-41c2-a4a2-e54afabc3ade/link-organizer/
Traceback (most recent call last):
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/core/handlers/exception.py", line 55, in inner
    response = get_response(request)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/core/handlers/base.py", line 198, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/views/decorators/csrf.py", line 65, in _view_wrapper
    return view_func(request, *args, **kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/viewsets.py", line 125, in view
    return self.dispatch(request, *args, **kwargs)
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 515, in dispatch
    response = self.handle_exception(exc)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 475, in handle_exception
    self.raise_uncaught_exception(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 486, in raise_uncaught_exception
    raise exc
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 512, in dispatch
    response = handler(request, *args, **kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/src/organizations/views.py", line 373, in link_organizer
    invite_url = f"{settings.FRONTEND_URL}/dashboard/organizations/accept-invite?token={token}"
                    ^^^^^^^^
NameError: name 'settings' is not defined. Did you mean: 'self.settings'?
=============================== warnings summary ===============================
src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_get_plans
src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_upgrade_subscription
src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_invite_organizer_external
src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_invite_organizer_non_existent
  /Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/core/handlers/base.py:62: UserWarning: No directory at: /Users/rutvikrj26/Desktop/cpd_events/backend/src/staticfiles/
    mw_instance = middleware(adapted_handler)

src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_get_plans
  /Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/drf_yasg/views.py:100: DeprecationWarning: SwaggerJSONRenderer & SwaggerYAMLRenderer's `format` has changed to not include a `.` prefix, please silence this warning by setting `SWAGGER_USE_COMPAT_RENDERERS = False` in your Django settings and ensure your application works (check your URLCONF and swagger/redoc URLs).
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_upgrade_subscription
FAILED src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_invite_organizer_external
=================== 2 failed, 2 passed, 5 warnings in 12.06s ===================
