============================= test session starts ==============================
platform darwin -- Python 3.13.4, pytest-8.4.2, pluggy-1.6.0
django: version: 6.0, settings: config.settings.development (from env)
rootdir: /Users/rutvikrj26/Desktop/cpd_events/backend
configfile: pyproject.toml
plugins: cov-4.1.0, django-4.11.1, Faker-22.7.0
collected 4 items

src/organizations/tests/test_plans_and_billing.py .F..                   [100%]

=================================== FAILURES ===================================
__________ TestOrganizationPlansAndBilling.test_upgrade_subscription ___________

self = <organizations.tests.test_plans_and_billing.TestOrganizationPlansAndBilling object at 0x10d77d1d0>
mock_stripe = <MagicMock name='stripe_service' id='4538337328'>
organizer_client = <rest_framework.test.APIClient object at 0x10f102850>
organization = <Organization: Test Org>

    @patch('organizations.views.stripe_service')
    def test_upgrade_subscription(self, mock_stripe, organizer_client, organization):
        mock_stripe.create_checkout_session.return_value = {'success': True, 'url': 'https://stripe.com/checkout'}
    
        url = f'/api/v1/organizations/{organization.uuid}/subscription/upgrade/'
        data = {'plan': 'team'}
    
    
>       response = organizer_client.post(url, data)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

src/organizations/tests/test_plans_and_billing.py:66: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.13/site-packages/rest_framework/test.py:299: in post
    response = super().post(
.venv/lib/python3.13/site-packages/rest_framework/test.py:213: in post
    return self.generic('POST', path, data, content_type, **extra)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/test.py:237: in generic
    return super().generic(
.venv/lib/python3.13/site-packages/django/test/client.py:671: in generic
    return self.request(**r)
           ^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/test.py:289: in request
    return super().request(**kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/test.py:241: in request
    request = super().request(**kwargs)
              ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/django/test/client.py:1087: in request
    self.check_exception(response)
.venv/lib/python3.13/site-packages/django/test/client.py:802: in check_exception
    raise exc_value
.venv/lib/python3.13/site-packages/django/core/handlers/exception.py:55: in inner
    response = get_response(request)
               ^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/django/core/handlers/base.py:198: in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/django/views/decorators/csrf.py:65: in _view_wrapper
    return view_func(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/viewsets.py:125: in view
    return self.dispatch(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/views.py:515: in dispatch
    response = self.handle_exception(exc)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/rest_framework/views.py:475: in handle_exception
    self.raise_uncaught_exception(exc)
.venv/lib/python3.13/site-packages/rest_framework/views.py:486: in raise_uncaught_exception
    raise exc
.venv/lib/python3.13/site-packages/rest_framework/views.py:512: in dispatch
    response = handler(request, *args, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <organizations.views.OrganizationViewSet object at 0x10e8e07d0>
request = <rest_framework.request.Request: POST '/api/v1/organizations/bc94532f-48e3-492d-ad19-060947fcd4ba/subscription/upgrade/'>
pk = 'bc94532f-48e3-492d-ad19-060947fcd4ba'

    @action(detail=True, methods=['post'], url_path='subscription/upgrade')
    def upgrade_subscription(self, request, pk=None):
        """
        Upgrade organization subscription.
        Creates a Stripe Checkout Session for the upgrade.
        """
        organization = self.get_object()
    
        # Check permissions (Owner/Admin only)
        if not organization.memberships.filter(
            user=request.user, role__in=['owner', 'admin'], is_active=True
        ).exists():
             return Response(
                {'detail': 'You do not have permission to manage billing.'},
                status=status.HTTP_403_FORBIDDEN,
            )
    
        plan = request.data.get('plan')
        if not plan:
            return Response({'detail': 'Plan is required.'}, status=status.HTTP_400_BAD_REQUEST)
    
        from billing.services import stripe_service
        from django.conf import settings
    
        # Create checkout session
        success_url = f"{settings.FRONTEND_URL}/dashboard/organizations/{organization.slug}/billing?success=true"
        cancel_url = f"{settings.FRONTEND_URL}/dashboard/organizations/{organization.slug}/billing?canceled=true"
    
>       result = stripe_service.create_checkout_session(
            user=request.user,
            plan=plan,
            success_url=success_url,
            cancel_url=cancel_url,
            organization_uuid=str(organization.uuid), # Pass organization UUID for webhook
        )
E       TypeError: StripeService.create_checkout_session() got an unexpected keyword argument 'organization_uuid'

src/organizations/views.py:469: TypeError
----------------------------- Captured stderr call -----------------------------
Internal Server Error: /api/v1/organizations/bc94532f-48e3-492d-ad19-060947fcd4ba/subscription/upgrade/
Traceback (most recent call last):
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/core/handlers/exception.py", line 55, in inner
    response = get_response(request)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/core/handlers/base.py", line 198, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/views/decorators/csrf.py", line 65, in _view_wrapper
    return view_func(request, *args, **kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/viewsets.py", line 125, in view
    return self.dispatch(request, *args, **kwargs)
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 515, in dispatch
    response = self.handle_exception(exc)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 475, in handle_exception
    self.raise_uncaught_exception(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 486, in raise_uncaught_exception
    raise exc
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 512, in dispatch
    response = handler(request, *args, **kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/src/organizations/views.py", line 469, in upgrade_subscription
    result = stripe_service.create_checkout_session(
        user=request.user,
    ...<3 lines>...
        organization_uuid=str(organization.uuid), # Pass organization UUID for webhook
    )
TypeError: StripeService.create_checkout_session() got an unexpected keyword argument 'organization_uuid'
------------------------------ Captured log call -------------------------------
ERROR    django.request:log.py:249 Internal Server Error: /api/v1/organizations/bc94532f-48e3-492d-ad19-060947fcd4ba/subscription/upgrade/
Traceback (most recent call last):
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/core/handlers/exception.py", line 55, in inner
    response = get_response(request)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/core/handlers/base.py", line 198, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/views/decorators/csrf.py", line 65, in _view_wrapper
    return view_func(request, *args, **kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/viewsets.py", line 125, in view
    return self.dispatch(request, *args, **kwargs)
           ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 515, in dispatch
    response = self.handle_exception(exc)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 475, in handle_exception
    self.raise_uncaught_exception(exc)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 486, in raise_uncaught_exception
    raise exc
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/rest_framework/views.py", line 512, in dispatch
    response = handler(request, *args, **kwargs)
  File "/Users/rutvikrj26/Desktop/cpd_events/backend/src/organizations/views.py", line 469, in upgrade_subscription
    result = stripe_service.create_checkout_session(
        user=request.user,
    ...<3 lines>...
        organization_uuid=str(organization.uuid), # Pass organization UUID for webhook
    )
TypeError: StripeService.create_checkout_session() got an unexpected keyword argument 'organization_uuid'
=============================== warnings summary ===============================
src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_get_plans
src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_upgrade_subscription
src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_invite_organizer_external
src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_invite_organizer_non_existent
  /Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/django/core/handlers/base.py:62: UserWarning: No directory at: /Users/rutvikrj26/Desktop/cpd_events/backend/src/staticfiles/
    mw_instance = middleware(adapted_handler)

src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_get_plans
  /Users/rutvikrj26/Desktop/cpd_events/backend/.venv/lib/python3.13/site-packages/drf_yasg/views.py:100: DeprecationWarning: SwaggerJSONRenderer & SwaggerYAMLRenderer's `format` has changed to not include a `.` prefix, please silence this warning by setting `SWAGGER_USE_COMPAT_RENDERERS = False` in your Django settings and ensure your application works (check your URLCONF and swagger/redoc URLs).
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED src/organizations/tests/test_plans_and_billing.py::TestOrganizationPlansAndBilling::test_upgrade_subscription
=================== 1 failed, 3 passed, 5 warnings in 18.94s ===================
